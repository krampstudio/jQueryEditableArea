/**
 * Copyright (c) 2012 Bertrand Chevrier
 * jQueryEditableArea - v0.0.1 
 * @author Bertrand Chevrier <chevrier.bertrand@gmail.com>
 * @license <%= _.pluck(pkg.licenses, "url").join(", ")
 */

(function(e){"use strict";var t={_opts:{save:{label:"Save"},cancel:{label:"Cancel"},cssClass:"editable",hoverClass:"editablearea-hover",ctrlBoxClass:"editablearea-control-box",exclusive:!1},_editor:{script:"../lib/jwysiwyg/jquery.wysiwyg.js",stylesheet:"../lib/jwysiwyg/jquery.wysiwyg.css",createEditor:function(e){e.wysiwyg()},_initialized:!1},_editing:[],_isEditing:function(n){return e.inArray(n,t._editing)>-1},setupEditor:function(){if(this._editor&&typeof this._editor=="object"){var n=this._editor;n.stylesheet&&t._loadScript(n.stylesheet,function(t){t&&e.error(t)}),n.script?t._loadScript(n.script,function(t){t?e.error(t):n._initialized=!0}):n._initialized=!0}},setupArea:function(n){var r=t._editor;r&&!r._initialized&&t.setupEditor();var i=e.extend(!0,{},t._opts,n);return this.each(function(){var n=e(this),s=n.attr("id");s||e.error("editable areas must be identified by a unique id"),n.hasClass(i.cssClass)||n.addClass(i.cssClass),n.mouseover(function(){t._isEditing(s)||(n.css("cursor","pointer"),i.hoverClass&&n.addClass(i.hoverClass))}).mouseout(function(){n.css("cursor","default"),i.hoverClass&&n.removeClass(i.hoverClass)}).click(function(){if(!t._isEditing(s)){t._editing.push(s);var o=n.children().length===0?"text":"wysiwyg",u,a;o=="text"?(u=e("<input type='text' />"),a=n.text(),u.val(a).attr("id",s+"_edit").width(parseInt(n.width(),10)+"px"),n.empty().append(u)):(u=e("<textarea />"),a=n.html(),u.val(a).attr("id",s+"_edit").width(parseInt(n.width(),10)+"px"),n.empty().append(u),r&&typeof r.createEditor=="function"&&t._editor.createEditor(u)),n.data("editableArea",{type:o,baseValue:a}),i.fieldClass&&n.addClass(i.fieldClass);var f=s+"_edit_control_save",l=s+"_edit_control_cancel",c=e("<div class='"+i.ctrlBoxClass+"'>"+"<a id='"+l+"' href='#'>"+i.cancel.label+"</a> "+"<a id='"+f+"' href='#'>"+i.save.label+"</a>"+"</div>");n.append(c),e.ui&&e("a",c).button(),n.trigger("open.editableArea"),e("#"+f).click(function(){var t=e(this).attr("id").replace("_edit_control_save",""),n=e("#"+t);n.trigger("save.editableArea",n.editableArea("getValues")),n.trigger("close.editableArea")}),e("#"+l).click(function(){var t=e(this).attr("id").replace("_edit_control_cancel","");e("#"+t).editableArea("destroy")})}}).on("close.editableArea",function(){e(this).editableArea("closeArea")}),n.trigger("initialized.editableArea")})},closeArea:function(n){return this.each(function(){var r=e(this);if(t._isEditing(r.attr("id"))){n=n||r.editableArea("getValues");var i=r.data("editableArea");r.empty();switch(i.type){case"wysiwyg":r.html(n);break;case"text":r.text(n)}setTimeout(function(){var e=t._editing.indexOf(r.attr("id"));t._editing.splice(e,1)},1)}})},getValues:function(){var n=[];return this.each(function(){var r=e(this);if(t._isEditing(r.attr("id"))){var i=e("#"+r.attr("id")+"_edit",r),s=r.data("editableArea");switch(s.type){case"text":n.push(i.val());break;case"wysiwyg":n.push(i.wysiwyg("getContent"))}}}),n.length===1?n[0]:n},destroy:function(){this.each(function(){var n=e(this);if(t._isEditing(n.attr("id"))){var r=n.data("editableArea");n.editableArea("closeArea",r.baseValue)}n.off(".editableArea")})}};t._loadScript=function(t,n){location.protocol==="file:"?e.error("Dynamic script loading is only supported on HTTP"):(/\.css$/.test(t)&&e("head").append("<link rel='stylesheet' type='text/css' href='"+t+"' />"),/\.js$/.test(t)&&e.getScript(t).done(function(t,r){n(null)}).fail(function(t,r,i){n(i)}))},e.editableArea={},e.editableArea.setUpEditor=function(n){e.extend(t._editor,n)},e.fn.editableArea=function(n){if(t[n]){if(!/^_/.test(n))return t[n].apply(this,Array.prototype.slice.call(arguments,1));e.error("Trying to call a private method "+n+" on jQuery.pluginName")}else{if(typeof n=="object"||!n)return t.setupArea.apply(this,arguments);e.error("Method "+n+" does not exist on jQuery.editableArea")}}})(jQuery);