/**
 * Copyright (c) 2012 Bertrand Chevrier
 * jQueryEditableArea - v0.0.1 
 * @author Bertrand Chevrier <chevrier.bertrand@gmail.com>
 * @license <%= _.pluck(pkg.licenses, "url").join(", ")
 */

(function(e){"use strict";var t={_opts:{save:{label:"Save"},cancel:{label:"Cancel"},cssClass:"editable"},_editing:[],_isEditing:function(n){return e.inArray(n,t._editing)>-1},setupArea:function(n){var r=e.extend(!0,{},t._opts,n);return this.each(function(){var n=e(this),i=n.attr("id");i||e.error("editable areas must be identified by a unique id"),n.hasClass(r.cssClass)||n.addClass(r.cssClass),n.mouseover(function(){t._isEditing(i)||(n.css("cursor","pointer"),r.hoverClass&&n.addClass(r.hoverClass))}).mouseout(function(){n.css("cursor","default"),r.hoverClass&&n.removeClass(r.hoverClass)}).click(function(){if(!t._isEditing(i)){t._editing.push(i);var s=n.children().length===0?"text":"wysiwyg",o,u;s=="text"?(o=e("<input type='text' />"),u=n.text(),o.val(u).attr("id",i+"_edit").width(parseInt(n.width(),10)+"px"),n.empty().append(o)):(o=e("<textarea />"),u=n.html(),o.val(u).attr("id",i+"_edit").width(parseInt(n.width(),10)+"px"),n.empty().append(o),o.wysiwyg()),n.data("editableArea",{type:s,baseValue:u}),r.fieldClass&&n.addClass(r.fieldClass);var a=i+"_edit_control_save",f=i+"_edit_control_cancel",l=e("<div class='editablearea-control-box'><a id='"+f+"' href='#'>"+r.cancel.label+"</a> "+"<a id='"+a+"' href='#'>"+r.save.label+"</a>"+"</div>");n.append(l),e.ui&&e("a",l).button(),e("#"+a).click(function(){var t=e(this).attr("id").replace("_edit_control_save",""),n=e("#"+t);n.trigger("save.editableArea",n.editableArea("getValue")),n.trigger("close.editableArea")}),e("#"+f).click(function(){var t=e(this).attr("id").replace("_edit_control_cancel","");e("#"+t).editableArea("destroy")})}}).on("close.editableArea",function(){e(this).editableArea("closeArea")})})},closeArea:function(n){return this.each(function(){var r=e(this);if(t._isEditing(r.attr("id"))){n=n||r.editableArea("getValue");var i=r.data("editableArea");r.empty();switch(i.type){case"wysiwyg":r.html(n);break;case"text":r.text(n)}setTimeout(function(){var e=t._editing.indexOf(r.attr("id"));t._editing.splice(e,1)},1)}})},getValue:function(){var n=[];return this.each(function(){var r=e(this);if(t._isEditing(r.attr("id"))){var i=e("#"+r.attr("id")+"_edit",r),s=r.data("editableArea");switch(s.type){case"text":n.push(i.val());break;case"wysiwyg":n.push(i.wysiwyg("getContent"))}}}),n.length===1?n[0]:n},destroy:function(){this.each(function(){var n=e(this);console.log("destroy");if(t._isEditing(n.attr("id"))){var r=n.data("editableArea");n.editableArea("closeArea",r.baseValue)}n.off(".editableArea")})}};e.fn.editableArea=function(n){if(t[n]){if(!/^_/.test(n))return t[n].apply(this,Array.prototype.slice.call(arguments,1));e.error("Trying to call a private method "+n+" on jQuery.pluginName")}else{if(typeof n=="object"||!n)return t.setupArea.apply(this,arguments);e.error("Method "+n+" does not exist on jQuery.editableArea")}}})(jQuery);